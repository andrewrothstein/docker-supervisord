---
machine:
  services:
    - docker

dependencies:
  pre:
    - sudo -H pip install --upgrade pip
    - sudo -H pip install circleci-helpers
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD -e $DOCKER_EMAIL $DOCKER_REGISTRY

test:
  override:
    - ? | 
          circle-matrix <<"EHD"
            env:
              - OS=alpine_3.3
              - OS=alpine_3.4
              - OS=alpine_edge
              - OS=centos_7
              - OS=debian_jessie
              - OS=fedora_23
              - OS=fedora_24
              - OS=ubuntu_trusty
              - OS=ubuntu_xenial

            before_script:
              - export TARGET_USER="andrewrothstein"
              - export TARGET_APP="docker-ansible-onbuild"
              - export TARGET_CONTAINER=${TARGET_USER}/${TARGET_APP}_$OS
              - env | sort

            script:
              - echo "FROM andrewrothstein/docker-ansible-onbuild:$OS" > Dockerfile.$OS
              - echo 'ENTRYPOINT ["/usr/local/bin/dumb-init", "-c", "--"]' >> Dockerfile.$OS
              - echo 'CMD ["sh", "-l", "-c", "/usr/local/bin/boot-supervisord.sh"]' >> Dockerfile.$OS
              - docker build -t $TARGET_CONTAINER -f Dockerfile.$OS .

            after_script:
              - docker images $TARGET_CONTAINER
          EHD
      :
        parallel: true
